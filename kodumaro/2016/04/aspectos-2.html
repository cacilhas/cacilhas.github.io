<!DOCTYPE html><html lang="pt"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatibile" content="IE=edge"/><meta http-equiv="Pragma" content="no-cache"/><meta http-equiv="Cache-Control" content="no-cache"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content=""/><meta name="author" content="ℜodrigo Arĥimedeς ℳontegasppα ℭacilhας"/><link rel="stylesheet" href="/css/bootstrap.min.css"/><link rel="stylesheet" href="/css/ie10-viewport-bug-workaround.css"/><link rel="stylesheet" href="/css/bootstrap-theme.min.css"/><link rel="stylesheet" href="/css/theme.css"/><link rel="stylesheet" href="/css/cacilhas.css"/><title>Kodumaro :: Aspectos – parte Ⅱ</title><link rel="alternate" type="application/atom+xml" title="Kodumaro" href="http://cacilhas.info/kodumaro/feed.xml"/><link rel="stylesheet" href="/css/kodumaro.css"/><link rel="icon" href="/img/kodumaro.ico"/><script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script><script src="/js/ie-emulation-modes-warning.js"></script><script src="/js/jquery.min.js"></script><script src="/js/handle-old-url.js"></script><script src="/js/anchors.js"></script></head><body><nav class="navbar navbar-inverse navbar-fixed-top"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-togge="collapse" data-target="#navbar" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"></a></div><div class="collapse navbar-collapse" id="navbar"><ul class="nav navbar-nav"><li><a href="/">Início</a></li><li><a href="/about.html">Sobre</a></li><li><a href="http://cacilhas.info/kodumaro/">Kodumaro</a></li><li class="active"><a href=".">Aspectos – parte Ⅱ</a></li></ul></div></div></nav><div class="container"><div class="panel panel-default"><div class="panel-heading"><h2 class="mg-title">Kodumaro :: Aspectos – parte Ⅱ</h2><h6 class="pull-right">Publicado em 19 de Abril, 2016</h6><h6>As sombras da programação.</h6></div><div class="panel-body"><img class="pull-right" src="/img/python.png" alt="Python"/><p class="mg-first">Na <a href="http://cacilhas.info/kodumaro/2016/04/aspectos.html">parte I demos uma</a> passada rápida no conceito de <a href="http://pt.wikipedia.org/wiki/Programação_orientada_a_aspecto"><aspectos></aspectos></a>. Agora versmos os <a href="http://en.wikipedia.org/wiki/Mixin"><em>mixins</em></a>.</p><p><em>Mixins</em> são classes incompletas que apenas atribuem determinado comportamento a suas herdeiras.</p><p>Vamos a um exemplo muito superficial, mas suficiente: um objeto que armazenanotas de alunos em um arquivo.</p><pre class="prettyprint"><code class="language-python">from typing import TypeVar
from numbers import Integral, Number
from pickle import dumps, loads
import dbm

__all__ = ['Database', 'Grades']

FileType = TypeVar('File', str, '_gdbm.gdbm')


class Database:

    def __init__(self, file: FileType=None):
        if file is None:
            file = 'grades.db'
        if isinstance(file, str):
            file = dbm.open(file, 'c')
        self.file = file

    def close(self) -&gt; None:
        if self.file:
            self.file.close()
            self.file = None


class Grades:

    def __init__(self, registration: Integral, db: Database):
        self.registration = registration
        if not isinstance(db, Database):
            raise TypeError('expected Database instance, got {.__name__}'
                            .format(type(db)))
        self.db = db

        try:
            self.values = loads(db[bytes(str(registration), 'ascii')])
        except KeyError:
            self.values = {}

    def save(self) -&gt; None:
        db[bytes(str(self.registration), 'ascci')] = dumps(self.values)

    @property
    def first_bimester(self) -&gt; Number:
        return self.values.get('1bim')

    @first_bimester.setter
    def first_bimester(self, value: Number) -&gt; None:
        self.values['1bim'] = float(value)

    @property
    def second_bimester(self) -&gt; Number:
        return self.values.get('2bim')

    @second_bimester.setter
    def second_bimester(self, value: Number) -&gt; None:
        self.values['2bim'] = float(value)

    @property
    def third_bimester(self) -&gt; Number:
        return self.values.get('3bim')

    @third_bimester.setter
    def third_bimester(self, value: Number) -&gt; None:
        self.values['3bim'] = float(value)

    @property
    def fourth_bimester(self) -&gt; Number:
        return self.values.get('4bim')

    @fourth_bimester.setter
    def fourth_bimester(self, value: Number) -&gt; None:
        self.values['4bim'] = float(value)

    @property
    def catch_up(self) -&gt; Number:
        return self.values.get('rec')

    @catch_up.setter
    def catch_up(self, value: Number) -&gt; None:
        return self.values['rec'] = float(value)

    @property
    def avg_grade(self) -&gt; None:
        grades = (
            self.first_bimester or 0,
            self.second_bimester or 0,
            self.third_bimester or 0,
            self.fourth_bimester or 0,
        )
        m = sum(grades) / len(grades)
        ca = self.catch_up
        return m if ca is None else (m + ca) / 2
</code></pre><p>Repare que temos o mesmo problema apresentando na parte I: está tudo misturadoem uma única classe!</p><p>Podemos separar as partes de gerência de banco e serialização em classes diferentes, dedicadas a seu próprio aspecto, chamadas <em>mixins</em>.</p><p>A classe de faz serialização pode ser apenas isso:</p><pre class="prettyprint"><code class="language-python">class SerialisableGradeMixin:

    def load(self) -&gt; None:
        s = self.retrieve()
        self.values = loads(s) if s else {}

    def __bytes__(self) -&gt; None:
      return dumps(self.values)
</code></pre><p>A gerência de banco vai para outro <em>mixin</em>:</p><pre class="prettyprint"><code class="language-python">class PersistenceMixin:

    def retrieve(self) -&gt; bytes:
        try:
            return self.db[bytes(str(self.registration), 'ascii')]
        except KeyError:
            return None

    def save(self) -&gt; None:
        db[bytes(str(self.registration), 'ascii')] = bytes(self)
</code></pre><p>Preferindo, é possível separar a gerência de notas em um <em>mixin</em> também:</p><pre class="prettyprint"><code class="language-python">class GradesMixin:

    @property
    def first_bimester(self) -&gt; Number:
        return self.values.get('1bim')

    @first_bimester.setter
    def first_bimester(self, value: Number) -&gt; None:
        self.values['1bim'] = float(value)

    ...

    @property
    def catch_up(self) -&gt; Number:
        return self.values.get('rec')

    @catch_up.setter
    def catch_up(self, value: Number) -&gt; None:
        return self.values['rec'] = float(value)

    @property
    def avg_grade(self) -&gt; None:
        grades = (
            self.first_bimester or 0,
            self.second_bimester or 0,
            self.third_bimester or 0,
            self.fourth_bimester or 0,
        )
        m = sum(grades) / len(grades)
        ca = self.catch_up
        return m if ca is None else (m + ca) / 2
</code></pre><p>Ao final, a classe principal será apenas uma cola dos <em>mixins</em>:</p><pre class="prettyprint"><code class="language-python">class Grades(SerialisableGradeMixin, PersistenceMixin, GradesMixin):

    def __init__(self, registration: Integral, db: Database):
        self.registration = registration
        if not isinstance(db, Database):
            raise TypeError('expected Database instance, got {.__name__}'
                            .format(type(db)))
        self.db = db
        self.load()
</code></pre><p>A API da classe continua idêntica: recebe o número da matrícula e o banco na instanciação, propriedades para acessar as notas e método <code>save</code> para
 salvá-las em arquivo, porém agora cada aspecto está isolado e encapsulado
 em seu próprio <em>mixin</em>.</p></div></div><div class="panel panel-default"><div class="panel-body"><div id="disqus_thread"></div><script language="javascript">var disqus_config = function() {
  this.page.url = `${mainHost}/${current.path.join("/")}.html`
  this.page.identifier = `${current.path.slice(1).join(".")}`
  this.page.title = 'Aspectos – parte Ⅱ'
}</script><noscript>Por favor habilite o JavaScript para ver os <a href="https://disqus.com/?ref_noscript">comentários do Disqus</a>.</noscript></div></div></div><div class="panel-footer" id="footer"><p class="pull-left"><a href="http://cacilhas.info/kodumaro/feed.xml" target="_blank" type="application/atom+xml"><img src="/img/rss.png" alt="feed"></a></p><p class="small">Autor: Arĥimedeς ℳontegasppα ℭacilhας &nbsp;<a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.pt"><img alt="[CC-BY 4.0]" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0"></a></p></div><script src="/js/bootstrap.min.js"></script><script src="/js/ie10-viewport-bug-workaround.js"></script><script src="/js/kodumaro.disqus.js"></script><script id="dsq-count-scr" src="//kodumaro.disqus.com/count.js" async></script></body></html>